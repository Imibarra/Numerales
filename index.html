<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clasificador de Numerales</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Configuración personalizada de la fuente Inter */
        html { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 flex items-center justify-center">

    <!-- Contenedor principal de la aplicación -->
    <div id="app-container" class="w-full max-w-2xl bg-white shadow-2xl rounded-xl p-8 transition-all duration-300">
        <header class="text-center mb-8">
            <h1 class="text-3xl font-extrabold text-indigo-700">Identificador de Numerales</h1>
            <p class="text-gray-500 mt-2">Encuentra el numeral en la oración y clasifícalo.</p>
            <!-- ID de Usuario OCULTO, solo visible si se quita la clase 'hidden' -->
            <p id="user-id-display" class="hidden text-xs mt-1 text-gray-400">ID Usuario: Cargando...</p>
        </header>

        <!-- Zona de Oración y Controles -->
        <main>
            <div id="sentence-card" class="bg-indigo-50 p-6 rounded-lg border-2 border-indigo-200 mb-6 shadow-inner">
                <p class="text-sm font-medium text-indigo-600 mb-2">Pregunta <span id="current-index">0</span> de <span id="total-sentences">0</span></p>
                <!-- Usamos text-lg para hacer la oración más legible -->
                <p id="sentence-text" class="text-xl font-semibold text-gray-800 italic">Cargando ejercicio...</p>
            </div>

            <!-- Inputs del Usuario -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                
                <!-- Input: Numeral -->
                <div class="space-y-1">
                    <label for="numeral-input" class="block text-sm font-medium text-gray-700">1. Identifica el Numeral</label>
                    <input type="text" id="numeral-input" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" placeholder="Escribe el numeral...">
                </div>

                <!-- Select: Tipo -->
                <div class="space-y-1">
                    <label for="type-select" class="block text-sm font-medium text-gray-700">2. Tipo de Numeral</label>
                    <select id="type-select" class="w-full p-2 border border-gray-300 rounded-lg bg-white focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                        <option value="" disabled selected>Seleccionar tipo</option>
                        <option value="cardinal">Cardinal</option>
                        <option value="ordinal">Ordinal</option>
                    </select>
                </div>

                <!-- Select: Función -->
                <div class="space-y-1">
                    <label for="function-select" class="block text-sm font-medium text-gray-700">3. Función Gramatical</label>
                    <select id="function-select" class="w-full p-2 border border-gray-300 rounded-lg bg-white focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                        <option value="" disabled selected>Seleccionar función</option>
                        <option value="determinante">Determinante</option>
                        <option value="nucleo">Núcleo</option>
                        <option value="complemento">Complemento</option>
                    </select>
                </div>
            </div>
            
            <!-- Botones y Puntuación -->
            <div class="flex flex-col sm:flex-row justify-between items-center space-y-4 sm:space-y-0 sm:space-x-4">
                <button id="check-button" onclick="checkAnswer()" class="w-full sm:w-auto px-6 py-3 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-indigo-500 focus:ring-opacity-50 transition duration-150 transform hover:scale-[1.01] shadow-lg shadow-indigo-200/50" disabled>
                    Comprobar Respuesta
                </button>
                <div class="text-lg font-bold text-gray-700 bg-gray-100 p-3 rounded-lg w-full sm:w-auto text-center">
                    Puntuación: <span id="score-display" class="text-indigo-600">0</span>
                </div>
            </div>

            <!-- Área de Feedback y Resultado -->
            <div id="feedback-area" class="mt-6 p-4 rounded-lg hidden transition-all duration-300" role="alert">
                <p id="feedback-message" class="font-medium"></p>
                <div id="correct-answer-details" class="text-sm mt-2 font-mono italic hidden"></div>
            </div>

            <button id="next-button" onclick="loadSentence(true)" class="hidden mt-4 w-full px-6 py-3 bg-green-500 text-white font-bold rounded-lg hover:bg-green-600 focus:outline-none focus:ring-4 focus:ring-green-400 focus:ring-opacity-50 transition duration-150 shadow-lg shadow-green-200/50">
                Siguiente Oración →
            </button>
            
            <button id="restart-button" onclick="restartQuiz()" class="hidden mt-4 w-full px-6 py-3 bg-yellow-500 text-white font-bold rounded-lg hover:bg-yellow-600 focus:outline-none focus:ring-4 focus:ring-yellow-400 focus:ring-opacity-50 transition duration-150 shadow-lg shadow-yellow-200/50">
                Reiniciar Prueba
            </button>
        </main>
    </div>

    <!-- Script de Firebase (MANDATORIO) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, getDoc, getDocs, query, where, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // setLogLevel('Debug'); // Habilitar logs de Firebase

        // Variables globales (Accedidas por window.app, window.db, etc.)
        window.quizData = [];
        window.currentSentenceIndex = 0;
        window.score = 0;
        window.app = null;
        window.db = null;
        window.auth = null;
        window.userId = null;
        window.isAuthReady = false;

        // 1. Configuración de Firebase
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        /**
         * Inicializa Firebase, autentica al usuario y carga la primera oración.
         */
        async function initializeAppAndAuth() {
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                    console.error("Firebase config is missing. Proceeding without database features.");
                    // Si no hay configuración, aún cargamos la interfaz
                    window.isAuthReady = true;
                    window.userId = 'anon-user-' + Math.random().toString(36).substring(2, 9);
                    // document.getElementById('user-id-display').textContent = `ID Usuario: ${window.userId} (Simulado)`;
                    window.loadSentence(false); // Cargar la primera oración sin esperar autenticación
                    return;
                }

                window.app = initializeApp(firebaseConfig);
                window.db = getFirestore(window.app);
                window.auth = getAuth(window.app);

                // Autenticación
                if (initialAuthToken) {
                    await signInWithCustomToken(window.auth, initialAuthToken);
                } else {
                    await signInAnonymously(window.auth);
                }

                // Esperar el cambio de estado de autenticación
                onAuthStateChanged(window.auth, (user) => {
                    if (user) {
                        window.userId = user.uid;
                        // document.getElementById('user-id-display').textContent = `ID Usuario: ${user.uid}`;
                        window.isAuthReady = true;
                        window.loadSentence(false);
                        console.log("Authentication successful. User ID:", user.uid);
                    } else {
                        // User signed out, or sign-in failed. This should not happen if custom token/anonymous works.
                        console.error("Authentication failed or user signed out.");
                        window.isAuthReady = true; // Still ready to proceed without auth features
                        window.loadSentence(false);
                    }
                });

            } catch (error) {
                console.error("Error during Firebase initialization or authentication:", error);
                window.isAuthReady = true;
                window.loadSentence(false);
            }
        }

        /**
         * Normaliza el texto eliminando tildes/acentos para permitir coincidencias flexibles.
         * @param {string} text El texto a normalizar.
         * @returns {string} El texto sin acentos.
         */
        function normalizeText(text) {
            if (!text) return '';
            // Usa normalize("NFD") para descomponer los caracteres con tildes en su base y el diacrítico, 
            // y luego remueve el diacrítico.
            return text.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        }

        // 2. Datos y Lógica del Quiz
        // Los datos se mantienen fijos para asegurar el orden. Se ajusta un caso para la consistencia
        // con la regla: Delante del sustantivo = Determinante (Vino una vez).
        window.quizData = [
            {
                sentence: 'Llegaron tres.',
                numeral: 'tres',
                type: 'cardinal',
                function: 'nucleo',
                hint: 'El numeral funciona como el sujeto de la oración, reemplazando al sustantivo (Núcleo).'
            },
            {
                sentence: 'Tomó dos más tarde.',
                numeral: 'dos',
                type: 'cardinal',
                function: 'nucleo',
                hint: 'El numeral actúa como objeto directo sin un sustantivo explícito (Núcleo).'
            },
            {
                sentence: 'Los primeros llegaron temprano.',
                numeral: 'primeros',
                type: 'ordinal',
                function: 'nucleo',
                hint: 'El numeral funciona como el sujeto de la oración (sustantivado por "Los"), por lo tanto es Núcleo.'
            },
            {
                sentence: 'Este es mi segundo café.',
                numeral: 'segundo',
                type: 'ordinal',
                function: 'determinante',
                hint: 'El numeral modifica directamente al sustantivo "café" y aparece delante de él (Determinante).'
            },
            {
                sentence: 'Compré cuatro manzanas.',
                numeral: 'cuatro',
                type: 'cardinal',
                function: 'determinante',
                hint: 'El numeral modifica directamente al sustantivo "manzanas" y aparece delante de él (Determinante).'
            },
            {
                sentence: 'Perdió por tres.',
                numeral: 'tres',
                type: 'cardinal',
                function: 'nucleo',
                hint: 'El numeral actúa como el complemento de la preposición "por", sin sustantivo explícito (Núcleo).'
            },
            {
                sentence: 'Ella vive en el piso quinto.',
                numeral: 'quinto',
                type: 'ordinal',
                function: 'complemento',
                hint: 'El numeral aparece detrás del sustantivo "piso", por lo tanto, es Complemento.'
            },
            {
                sentence: 'Necesito una respuesta.',
                numeral: 'una',
                type: 'cardinal',
                function: 'determinante',
                hint: 'El numeral modifica directamente al sustantivo "respuesta" y aparece delante de él (Determinante).'
            },
            {
                sentence: 'Llegamos dos.',
                numeral: 'dos',
                type: 'cardinal',
                function: 'nucleo',
                hint: 'El numeral funciona como el sujeto de la oración, reemplazando al sustantivo (Núcleo).'
            },
            {
                sentence: 'Este es su primer libro.',
                numeral: 'primer',
                type: 'ordinal',
                function: 'determinante',
                hint: 'El numeral modifica directamente al sustantivo "libro" y aparece delante de él (Determinante).'
            },
            {
                sentence: 'Pagó cinco por la entrada.',
                numeral: 'cinco',
                type: 'cardinal',
                function: 'nucleo',
                hint: 'El numeral actúa como objeto directo (cantidad de dinero) sin sustantivo explícito (Núcleo).'
            },
            {
                sentence: 'Se quedó en el asiento tercero.',
                numeral: 'tercero',
                type: 'ordinal',
                function: 'complemento',
                hint: 'El numeral aparece detrás del sustantivo "asiento", por lo tanto, es Complemento.'
            },
            {
                sentence: 'Leí veinte páginas.',
                numeral: 'veinte',
                type: 'cardinal',
                function: 'determinante',
                hint: 'El numeral modifica directamente al sustantivo "páginas" y aparece delante de él (Determinante).'
            },
            {
                sentence: 'Somos cuatro.',
                numeral: 'cuatro',
                type: 'cardinal',
                function: 'nucleo',
                hint: 'El numeral funciona como atributo o predicativo, reemplazando al sustantivo (Núcleo).'
            },
            {
                sentence: 'Alcanzó el puesto segundo.',
                numeral: 'segundo',
                type: 'ordinal',
                function: 'complemento',
                hint: 'El numeral aparece detrás del sustantivo "puesto", por lo tanto, es Complemento.'
            },
            {
                sentence: 'Compré dos flores.',
                numeral: 'dos',
                type: 'cardinal',
                function: 'determinante',
                hint: 'El numeral modifica directamente al sustantivo "flores" y aparece delante de él (Determinante).'
            },
            {
                sentence: 'Los terceros no participaron.',
                numeral: 'terceros',
                type: 'ordinal',
                function: 'nucleo',
                hint: 'El numeral funciona como el sujeto de la oración (sustantivado por "Los"), por lo tanto es Núcleo.'
            },
            {
                sentence: 'Esperamos treinta minutos.',
                numeral: 'treinta',
                type: 'cardinal',
                function: 'determinante',
                hint: 'El numeral modifica directamente al sustantivo "minutos" y aparece delante de él (Determinante).'
            },
            {
                sentence: 'Vino una vez.',
                numeral: 'una',
                type: 'cardinal',
                function: 'determinante', // Ajustado a Determinante (Delante del sustantivo "vez")
                hint: 'El numeral "una" aparece delante del sustantivo "vez", por lo tanto, es Determinante.'
            },
            {
                sentence: 'El capítulo octavo es el más largo.',
                numeral: 'octavo',
                type: 'ordinal',
                function: 'determinante',
                hint: 'El numeral modifica directamente al sustantivo "capítulo" y aparece delante de él (Determinante).'
            },
            {
                sentence: 'Vi seis en la mesa.',
                numeral: 'seis',
                type: 'cardinal',
                function: 'nucleo',
                hint: 'El numeral actúa como objeto directo sin un sustantivo explícito (Núcleo).'
            },
            {
                sentence: 'Estamos en el piso décimo.',
                numeral: 'décimo',
                type: 'ordinal',
                function: 'complemento',
                hint: 'El numeral aparece detrás del sustantivo "piso", por lo tanto, es Complemento.'
            },
            {
                sentence: 'Compramos tres entradas.',
                numeral: 'tres',
                type: 'cardinal',
                function: 'determinante',
                hint: 'El numeral modifica directamente al sustantivo "entradas" y aparece delante de él (Determinante).'
            },
            {
                sentence: 'Ella terminó en lugar cuarto.',
                numeral: 'cuarto',
                type: 'ordinal',
                function: 'complemento',
                hint: 'El numeral aparece detrás del sustantivo "lugar", por lo tanto, es Complemento.'
            },
            {
                sentence: 'Llegaron dos temprano.',
                numeral: 'dos',
                type: 'cardinal',
                function: 'nucleo',
                hint: 'El numeral funciona como el sujeto de la oración, reemplazando al sustantivo (Núcleo).'
            },
            {
                sentence: 'Tienes una llamada.',
                numeral: 'una',
                type: 'cardinal',
                function: 'determinante',
                hint: 'El numeral modifica directamente al sustantivo "llamada" y aparece delante de él (Determinante).'
            },
            {
                sentence: 'Ocupó la habitación séptima.',
                numeral: 'séptima',
                type: 'ordinal',
                function: 'determinante',
                hint: 'El numeral modifica directamente al sustantivo "habitación" y aparece delante de él (Determinante).'
            },
            {
                sentence: 'Faltan cuatro para empezar.',
                numeral: 'cuatro',
                type: 'cardinal',
                function: 'nucleo',
                hint: 'El numeral funciona como el sujeto de la oración, reemplazando al sustantivo (Núcleo).'
            },
            {
                sentence: 'Fue su segundo intento.',
                numeral: 'segundo',
                type: 'ordinal',
                function: 'determinante',
                hint: 'El numeral modifica directamente al sustantivo "intento" y aparece delante de él (Determinante).'
            },
            {
                sentence: 'Conté cien personas.',
                numeral: 'cien',
                type: 'cardinal',
                function: 'determinante',
                hint: 'El numeral modifica directamente al sustantivo "personas" y aparece delante de él (Determinante).'
            }
        ];

        /**
         * Mezcla los elementos de un array. (FUNCIÓN NO USADA PARA MANTENER EL ORDEN FIJO)
         * @param {Array} array El array a mezclar.
         */
        window.shuffleArray = (array) => {
            // Se mantiene la función por si se quiere habilitar la aleatoriedad más tarde
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        };

        /**
         * Carga la oración actual en la interfaz.
         * @param {boolean} isNext Indica si se está cargando la siguiente oración después de una comprobación.
         */
        window.loadSentence = (isNext) => {
            document.getElementById('check-button').disabled = false;
            document.getElementById('next-button').classList.add('hidden');
            document.getElementById('feedback-area').classList.add('hidden');

            if (isNext) {
                window.currentSentenceIndex++;
            }

            // Si hemos terminado el quiz
            if (window.currentSentenceIndex >= window.quizData.length) {
                const finalScore = window.score;
                const total = window.quizData.length;
                document.getElementById('sentence-text').textContent = `¡Prueba terminada! Obtuviste ${finalScore} de ${total} respuestas correctas.`;
                document.getElementById('sentence-card').classList.remove('border-indigo-200');
                document.getElementById('sentence-card').classList.add('border-green-500');
                document.getElementById('check-button').classList.add('hidden');
                document.getElementById('restart-button').classList.remove('hidden');
                // Intentar guardar el puntaje si Firebase está listo
                if (window.isAuthReady && window.userId && window.db) {
                    saveScore(finalScore);
                }
                return;
            }
            
            // Cargar la siguiente oración
            const currentItem = window.quizData[window.currentSentenceIndex];
            // Importante: Usamos textContent para no resaltar el numeral.
            document.getElementById('sentence-text').textContent = currentItem.sentence;
            document.getElementById('current-index').textContent = window.currentSentenceIndex + 1;
            document.getElementById('total-sentences').textContent = window.quizData.length;

            // Limpiar inputs
            document.getElementById('numeral-input').value = '';
            document.getElementById('type-select').value = '';
            document.getElementById('function-select').value = '';
            document.getElementById('numeral-input').focus();
        };

        /**
         * Comprueba la respuesta del usuario.
         */
        window.checkAnswer = () => {
            const currentItem = window.quizData[window.currentSentenceIndex];
            const userInput = {
                numeral: document.getElementById('numeral-input').value.trim().toLowerCase(),
                type: document.getElementById('type-select').value,
                function: document.getElementById('function-select').value
            };

            // Normalizar la respuesta esperada
            const expected = {
                numeral: currentItem.numeral.toLowerCase(),
                type: currentItem.type,
                function: currentItem.function
            };

            // --- Lógica de comprobación de Numeral con tilde flexible ---
            const numeralInputNormalized = normalizeText(userInput.numeral);
            const expectedNumeralNormalized = normalizeText(expected.numeral);

            // 1. Comprobación estricta (con tilde)
            let isNumeralCorrect = userInput.numeral === expected.numeral; 
            
            // 2. Comprobación flexible (sin tilde)
            const isNumeralCorrectNormalized = numeralInputNormalized === expectedNumeralNormalized;
            
            // Flag para la advertencia de tilde
            let hasAccentWarning = false;

            if (!isNumeralCorrect && isNumeralCorrectNormalized) {
                // El usuario se equivocó en la tilde, pero la palabra es correcta.
                isNumeralCorrect = true; // Contar como correcto
                hasAccentWarning = true; // Mostrar aviso
            }

            // --- Comprobación de Tipo y Función ---
            const isTypeCorrect = userInput.type === expected.type;
            const isFunctionCorrect = userInput.function === expected.function;

            let isCorrect = isNumeralCorrect && isTypeCorrect && isFunctionCorrect;

            const feedbackArea = document.getElementById('feedback-area');
            const feedbackMessage = document.getElementById('feedback-message');
            const detailsDiv = document.getElementById('correct-answer-details');
            const nextButton = document.getElementById('next-button');

            // Mostrar el área de feedback
            feedbackArea.classList.remove('hidden', 'bg-red-100', 'bg-green-100');
            detailsDiv.classList.add('hidden');
            nextButton.classList.remove('hidden');
            document.getElementById('check-button').disabled = true;

            if (isCorrect) {
                window.score++;
                document.getElementById('score-display').textContent = window.score;
                feedbackArea.classList.add('bg-green-100');
                feedbackMessage.classList.add('text-green-800');
                
                feedbackMessage.textContent = '¡Correcto! Todos los campos son correctos.';

                if (hasAccentWarning) {
                    // Agrega el aviso si se omitió la tilde
                    feedbackMessage.innerHTML = '¡Correcto! Todos los campos son correctos. <span class="text-yellow-700 block mt-1 font-normal">⚠️ Aviso: ¡Recuerda la tilde en el numeral!</span>';
                }

                detailsDiv.textContent = `Numeral: ${expected.numeral.toUpperCase()}, Tipo: ${expected.type.toUpperCase()}, Función: ${expected.function.toUpperCase()}.`;
                detailsDiv.classList.remove('hidden');
            } else {
                feedbackArea.classList.add('bg-red-100');
                feedbackMessage.classList.add('text-red-800');

                // Detalle del error
                let errorMessages = ['**Respuesta Incorrecta.**'];
                // Notificamos específicamente los errores que llevaron a la respuesta incorrecta (Type/Function)
                if (!isNumeralCorrect) errorMessages.push(`Numeral: Esperábamos **${expected.numeral}** (¡o sin tilde si es el único error!).`);
                if (!isTypeCorrect) errorMessages.push(`Tipo: Esperábamos **${expected.type}**.`);
                if (!isFunctionCorrect) errorMessages.push(`Función: Esperábamos **${expected.function}**.`);

                feedbackMessage.innerHTML = errorMessages.join('<br>');
                detailsDiv.textContent = `La respuesta correcta es: Numeral: ${expected.numeral.toUpperCase()}, Tipo: ${expected.type.toUpperCase()}, Función: ${expected.function.toUpperCase()}. Sugerencia: ${currentItem.hint}`;
                detailsDiv.classList.remove('hidden');
            }
        };

        /**
         * Guarda el puntaje final del usuario en Firestore (si está inicializado).
         * @param {number} finalScore El puntaje final.
         */
        async function saveScore(finalScore) {
            if (!window.db || !window.userId) {
                console.log("Database not ready or user ID missing. Score not saved.");
                return;
            }
            try {
                const today = new Date().toISOString().split('T')[0];
                const docRef = doc(window.db, `artifacts/${appId}/users/${window.userId}/quiz_scores`, today);
                await setDoc(docRef, {
                    score: finalScore,
                    total: window.quizData.length,
                    timestamp: new Date().toISOString()
                }, { merge: true });
                console.log("Score saved successfully!");
            } catch (e) {
                console.error("Error saving document: ", e);
            }
        }
        
        /**
         * Reinicia el quiz al inicio.
         */
        window.restartQuiz = () => {
            window.score = 0;
            window.currentSentenceIndex = 0;
            document.getElementById('score-display').textContent = 0;
            document.getElementById('check-button').classList.remove('hidden');
            document.getElementById('restart-button').classList.add('hidden');
            document.getElementById('sentence-card').classList.remove('border-green-500');
            document.getElementById('sentence-card').classList.add('border-indigo-200');
            // NO se llama a window.shuffleArray para mantener el orden fijo.
            window.loadSentence(false);
        };

        // 3. Inicialización
        // NO se llama a window.shuffleArray para mantener el orden fijo.
        initializeAppAndAuth();

    </script>
</body>
</html>